<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Panel Operador - Plataforma Institucional</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- CSS personalizado -->
    <link rel="stylesheet" th:href="@{/css/inicio-operador.css}">
</head>
<body>

<div class="d-flex">
    <!-- MenÃº lateral -->
    <nav class="sidebar bg-primary text-white p-3 vh-100">
        <div class="text-center mb-4">
            <img src="/imagenes/escudo.png" alt="Escudo" width="80">
            <h5 class="mt-2">Operador</h5>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a th:href="@{/panel/operador}" class="nav-link text-white"><i class="bi bi-house-door-fill me-2"></i>Inicio</a></li>
            <li class="nav-item"><a th:href="@{/reportes}" class="nav-link text-white"><i class="bi bi-flag-fill me-2"></i>Reportes</a></li>
            <li class="nav-item"><a th:href="@{/panel/operador/asignaciones}" class="nav-link text-white"><i class="bi bi-person-lines-fill me-2"></i>Asignaciones</a></li>
            <li class="nav-item"><a th:href="@{/logout}" class="nav-link text-white"><i class="bi bi-box-arrow-right me-2"></i>Cerrar sesiÃ³n</a></li>
        </ul>
    </nav>

    <!-- Contenido principal -->
    <main class="p-4 flex-grow-1">
        <div class="container-fluid">
            <h2 class="mb-4">ðŸ“Š Panel del Operador Institucional</h2>

            <!-- NotificaciÃ³n de reportes pendientes -->
            <div class="alert alert-warning d-flex align-items-center d-none" role="alert" id="alertaNuevosReportes">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <div>Tienes nuevos reportes pendientes de revisar.</div>
            </div>

            <!-- Tarjetas resumen -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card bg-warning text-dark shadow-sm h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Reportes activos</h5>
                            <p class="display-6 fw-bold mb-0" th:text="${reportesActivos}">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-info text-dark shadow-sm h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Asignaciones pendientes</h5>
                            <p class="display-6 fw-bold mb-0" th:text="${asignacionesPendientes}">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-success text-white shadow-sm h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total reportes</h5>
                            <p class="display-6 fw-bold mb-0" th:text="${totalReportes}">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista rÃ¡pida de asignaciones -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-person-lines-fill me-2"></i>Asignaciones recientes
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Reporte</th>
                            <th>TÃ©cnico</th>
                            <th>Estado</th>
                            <th>AcciÃ³n</th>
                        </tr>
                        </thead>
                        <tbody id="tablaAsignaciones">
                        <!-- Contenido dinÃ¡mico desde JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Filtro flotante -->
            <div id="filtroFlotante" class="card shadow position-absolute p-3 bg-white border rounded filtro-panel">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong><i class="bi bi-funnel-fill me-2"></i>Filtros</strong>
                    <button class="btn btn-sm btn-outline-danger" onclick="ocultarFiltro()">âœ–</button>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="fw-bold">Tipos de reporte:</label>
                        <div id="filtroTipos" class="d-flex flex-wrap gap-2 mt-1"></div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="fw-bold">Estados de reporte:</label>
                        <div id="filtroEstados" class="d-flex flex-wrap gap-2 mt-1"></div>
                    </div>
                    <div class="mt-3 text-end">
                        <button class="btn btn-outline-primary btn-sm" onclick="mostrarTodosReportes()">
                            <i class="bi bi-layers"></i> Mostrar todos
                        </button>
                    </div>
                </div>
            </div>

            <!-- BotÃ³n flotante -->
            <button id="btnMostrarFiltro" class="btn btn-primary rounded-circle position-absolute filtro-btn" onclick="mostrarFiltro()" title="Mostrar filtros">
                <i class="bi bi-funnel-fill"></i>
            </button>

            <!-- Mapa -->
            <div class="card shadow-sm rounded">
                <div class="card-header d-flex align-items-center">
                    <i class="bi bi-geo-alt-fill me-2"></i>Reportes Geolocalizados
                </div>
                <div class="card-body">
                    <div id="map" class="map-container"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal detalle reporte -->
<div class="modal fade" id="modalDetalleReporte" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-light text-dark">
            <div class="modal-header">
                <h5 class="modal-title">Detalle del Reporte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contenidoModal"></div>
        </div>
    </div>
</div>

<!-- Modal confirmar asignaciÃ³n -->
<div class="modal fade" id="modalConfirmarAsignacion" tabindex="-1" aria-labelledby="modalConfirmarAsignacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-dark">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalConfirmarAsignacionLabel">Confirmar asignaciÃ³n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                Â¿EstÃ¡s segura de asignar este reporte al tÃ©cnico <strong id="nombreTecnicoModal"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="btnConfirmarAsignacion" type="button" class="btn btn-success">SÃ­, asignar</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/@googlemaps/markerclustererplus/dist/index.min.js"></script>
<script th:src="@{/js/operador.js}"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_1FjZtRLFk0h9dLAqUopMOi4FJn8t57s&callback=initMap"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const reportes = JSON.parse(/*[[${reportesJSON}]]*/ '[]');
    window.listaTecnicos = /*[[${tecnicos}]]*/ [];
    /*]]>*/
</script>

</body>
</html>
